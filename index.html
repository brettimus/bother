<html>
  <head>
      <link rel="stylesheet" href="js/codemirror-4.12/codemirror.css">
      <link rel="stylesheet" href="style.css">

      <script type="text/javascript" src="js/jspos-0.2.2/lexer.js"></script>
      <script type="text/javascript" src="js/jspos-0.2.2/lexicon.js"></script>
      <script type="text/javascript" src="js/jspos-0.2.2/POSTagger.js"></script>
      <script type="text/javascript" src="js/markov.js"></script>

      <script type="text/javascript" src="js/codemirror-4.12/codemirror-min.js"></script>

      <script type="text/javascript" src="js/jquery-1.11.2.min.js"></script>

      <script type="text/javascript" src="js/underscore-1.7.0/underscore-min.js"></script>
      <script type="text/javascript" src="js/persistent.js"></script>
      <script type="text/javascript" src="js/templates.js"></script>

      <script type="text/javascript" async src="https://platform.twitter.com/widgets.js"></script>

      <script type="text/javascript">

      const PERSIST_PREFIX = "_bother_storage_";
      const DATA = new PersistentMap(PERSIST_PREFIX);

      function clearAllChanges() {
        if(confirm("Are you sure? All edits to your corpus text and code will be lost!")) {
          DATA.reallyClearIMeanIt();
          location.reload();
        }
      }

      // LOLOLOL
      function compileFunction(params, body) {
        var proto = params.join(", ");
        var header = "var _internal = function(" + proto + ") {\n";
        var footer = "\n};\n_internal;";
        var code = header + body + footer;
        var func = undefined;

        try {
          func = eval(code);
        } catch (e) {
          console.error("Could not compile JS code:\n" + code);
        }

        return func;
      }

      function ready(){
        function tagPos(string){
          var words = new Lexer().lex(string);
          var taggedWords = new POSTagger().tag(words);
          var result = []
          for(var i = 0; i < taggedWords.length; i++){
            result.push({word : taggedWords[i][0], pos: taggedWords[i][1]});
          }
          return result;
        }

        function markovTrainAndGenerate(string){
          markov = new Markov(string, 5);
          results = [""];

          markov.each(function(t){
            if(results[results.length-1].length <= 140){
              results[results.length-1] += t;
            }else {
              results.push(t);
            }
          })

          return results;
        }

        $("#pos").submit(function(e){
          e.preventDefault();
          var inputText = $("#pos textarea").val();

          var tags = tagPos(inputText);

          var result = "";
          for(var i = 0; i < tags.length; i++){
            result = result + tags[i].word + " (" + tags[i].pos + ") ";
          }
          $("#pos-output").html(result);
        });

        $("#markov").submit(function(e){
          e.preventDefault();
          var corpus = $("#markov textarea").val();
          output = markovTrainAndGenerate(corpus);
          $("#markov-output").empty();
          for(var i = 0; i < output.length; i++){
            var tweet = candidateTweet(output[i]);
            $("#markov-output").append(tweet);
          }
        });

        $("#scratch").submit(function (e) {
          e.preventDefault();

          var source = $("#scratch #js-scratch").text();
          var func = compileFunction([], source);
          func();
        });

        $("textarea.editor").each(function(idx, textarea) {
            var config = {
              lineNumbers: true,
            }

            var e = $(textarea);
            var eId = e.attr("id");

            // see if we've persisted changes to this field
            if (eId && DATA.hasKey(eId)) {
              e.text(DATA.get(eId));
            }

            var editor = CodeMirror.fromTextArea(textarea, config);

            if (e.attr("data-mode")) {
              editor.setOption("mode", e.attr("data-mode"));
            } else {
              editor.setOption("mode", "text/plain");
            }

            editor.on("changes", function() {
              // accoding to the docs this should work, but...nope!
              //editor.save();
              // so we do it the manual way
              var value = editor.getValue();
              e.text(value);
              if (eId) {
                DATA.set(eId, value);
              }
            });
        });
      }

      document.addEventListener("DOMContentLoaded", ready, false);

</script>
<style>
#markov li{
  white-space: pre;
}
</style>

  </head>
  <body>
    <form id="toplevel-controls" action="#">
      <input type="button" class="caution" onclick="clearAllChanges()" value="clear all changes"/>
    </form>

    <h2>JavaScript scratchpad</h2>
    <form id="scratch" action="#">
      <textarea id="js-scratch" class="editor" data-mode="javascript">alert(1)</textarea>
      <p><input type="submit" value="evaluate"></p>
      <p id="scratch-output"></p>
    </form>

    <h2>Markov chains</h2>
    <form id="markov" action="#">
      <textarea id="markov-corpus" class="editor" cols=40 rows=5>Your corpus here.</textarea>
      <p><input type="submit" value="train and generate" /></p>
      <ul class="tweet-list" id="markov-output"></ul>
    </form>

    <h2>Part of Speech Tagging</h2>
    <form id="pos" action="#">
      <textarea id="pos-corpus" class="editor" cols=40 rows=5>Roses are red, violets are blue.</textarea>
      <p id="pos-output"></p>
      <p><input type="submit" value="tag" /></p>
    </form>
    <div id="pos-defs">
      <p>(via <a href="http://www.ling.upenn.edu/courses/Fall_2003/ling001/penn_treebank_pos.html">upenn</a>, standard NLP notation)

<ul>
<li>CC Coordinating conjunction
</li><li>CD Cardinal number
</li><li>DT Determiner
</li><li>EX Existential there
</li><li>FW Foreign word
</li><li>IN Preposition or subordinating conjunction
</li><li>JJ Adjective
</li><li>JJR Adjective, comparative
</li><li>JJS Adjective, superlative
</li><li>LS List item marker
</li><li>MD Modal
</li><li>NN Noun, singular or mass
</li><li>NNS Noun, plural
</li><li>NNP Proper noun, singular
</li><li>NNPS Proper noun, plural
</li><li>PDT Predeterminer
</li><li>POS Possessive ending
</li><li>PRP Personal pronoun
</li><li>PRP$ Possessive pronoun
</li><li>RB Adverb
</li><li>RBR Adverb, comparative
</li><li>RBS Adverb, superlative
</li><li>RP Particle
</li><li>SYM Symbol
</li><li>TO to
</li><li>UH Interjection
</li><li>VB Verb, base form
</li><li>VBD Verb, past tense
</li><li>VBG Verb, gerund or present participle
</li><li>VBN Verb, past participle
</li><li>VBP Verb, non-3rd person singular present
</li><li>VBZ Verb, 3rd person singular present
</li><li>WDT Wh-determiner
</li><li>WP Wh-pronoun
</li><li>WP$ Possessive wh-pronoun
</li><li>WRB Wh-adverb</li>
</ul>
  </body>

</html>
